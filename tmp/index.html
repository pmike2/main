<!--
Partie client
-->

<!DOCTYPE html>
<html>
	<head>
		<title>TEST</title>
		<link rel="stylesheet" href="config_edit.css">
		<link rel="stylesheet" href="polygons.css">
		<script src="./polygons.js" type="module"></script>
		<script src="./config_edit.js" type="module"></script>
		<script src="/socket.io/socket.io.js"></script>
		<script type="module">
			import {ConfigEdit} from './config_edit.js';
			import {PolygonsContext} from './polygons.js';
			
			var js_configs= null;
			var js_model= null;
			var config_edit= null;
			var keypresseds= {};
			var polygons_contexts= [];
			var socket= io();



			function svg_polygons_changed(detail) {
				//console.log("svg_polygons_changed : ");
				//console.log(detail);

				let reader_idx= parseInt(detail.svg_id.split("svg_alpha_polygons_")[1]);
				let change_type= detail.type;
				let node_alpha_polygons= "/readers/"+ reader_idx+ "/readers.alpha/alpha_polygons";
				let child_nodes= config_edit.get_children_ids(node_alpha_polygons);

				if (change_type== "clear") {
					for (let i=0; i<child_nodes.length; ++i) {
						config_edit.delete_id(config_edit.concat_ids(node_alpha_polygons, i));
						config_edit.get_div_node(child_nodes[i]).remove();
					}
				}
				else if (change_type== "add_polygon") {
					config_edit.add_default_to_list(node_alpha_polygons, child_nodes.length);
					config_edit.gen_dom(config_edit.concat_ids(node_alpha_polygons, child_nodes.length), config_edit.get_div_node(node_alpha_polygons));
				}
				else if (change_type== "remove_polygon") {
					let idx_polygon= detail.idx_polygon;
					config_edit.delete_id(config_edit.concat_ids(node_alpha_polygons, idx_polygon));
					config_edit.get_div_node(child_nodes[idx_polygon]).remove();
				}
				else if (change_type== "duplicate_polygon") {
					let idx_polygon= detail.idx_polygon;
					config_edit.add_default_to_list(node_alpha_polygons, child_nodes.length);
					config_edit.gen_dom(config_edit.concat_ids(node_alpha_polygons, child_nodes.length), config_edit.get_div_node(node_alpha_polygons));
				}
				else {
					let idx_polygon= detail.idx_polygon;
					config_edit.js_config["readers"][reader_idx]["readers.alpha"]["alpha_polygons"][idx_polygon]["polygon"]=
						polygons_contexts[reader_idx].polygons[idx_polygon];
				}

				socket.emit("config_changed", config_edit.js_config);
			}


			function sync_alpha_polygon(reader_idx, polygon_idx) {
				polygons_contexts[reader_idx].set_polygon(polygon_idx, config_edit.js_config["readers"][reader_idx]["readers.alpha"]["alpha_polygons"][polygon_idx]["polygon"]);
				polygons_contexts[reader_idx].update_polygon_group(polygon_idx);
			}


			function sync_alpha_polygons(reader_idx) {
				//console.log("sync_alpha_polygons : "+ reader_idx);
				let svg_alpha_polygons= document.getElementById("svg_alpha_polygons_"+ reader_idx);
				if (svg_alpha_polygons=== null) {
					svg_alpha_polygons= document.createElementNS("http://www.w3.org/2000/svg", "svg");
					svg_alpha_polygons.setAttribute("id", "svg_alpha_polygons_"+ reader_idx);
					svg_alpha_polygons.setAttribute("width", 300);
					svg_alpha_polygons.setAttribute("height", 300);
					svg_alpha_polygons.classList.add("svg_alpha_polygons");
					let div_alpha_polygons= config_edit.get_div_node("/readers/"+ reader_idx+ "/readers.alpha/alpha_polygons");
					div_alpha_polygons.appendChild(svg_alpha_polygons);
				}

				if (reader_idx< polygons_contexts.length) {
					delete polygons_contexts[reader_idx];
				}
				let polygons_context= new PolygonsContext(svg_alpha_polygons.getAttribute("id"), keypresseds);
				polygons_contexts.splice(reader_idx, 0, polygons_context);
				
				for (let polygon_idx=0; polygon_idx<config_edit.js_config["readers"][reader_idx]["readers.alpha"]["alpha_polygons"].length; ++polygon_idx) {
					sync_alpha_polygon(reader_idx, polygon_idx);
				}
			}


			function js_config_changed(detail) {
				let node_id= detail.node_id;
				console.log("js_config_changed : "+ node_id);

				const regex = new RegExp("^/readers/([0-9]+)/readers.alpha/alpha_polygons$");
				const found = node_id.match(regex);
				const regex2 = new RegExp("^/readers/([0-9]+)/readers.alpha/alpha_polygons/([0-9]+)$");
				const found2 = node_id.match(regex2);

				if ((node_id== "/readers") || (node_id== "/")) {
					polygons_contexts= [];
					let svgs_alpha_polygons= document.getElementsByClassName("svg_alpha_polygons");
					for (let i=0; i<svgs_alpha_polygons.length; ++i) {
						svgs_alpha_polygons[i].remove();
					}

					for (let reader_idx=0; reader_idx<config_edit.js_config["readers"].length; ++reader_idx) {
						sync_alpha_polygons(reader_idx);
					}
				}
				else if (found) {
					let reader_idx= parseInt(found[1]);
					sync_alpha_polygons(reader_idx);
				}
				else if (found2) {
					let reader_idx= parseInt(found2[1]);
					let polygon_idx= parseInt(found2[2]);
					sync_alpha_polygon(reader_idx, polygon_idx);
				}

				socket.emit("config_changed", config_edit.js_config);
			}

			
			window.onload= function () {
				socket.on('send_list_configs', (data) => {
					js_configs= data["configs"];
					js_model= data["model"];
					config_edit= new ConfigEdit(js_model, js_configs);
					config_edit.send_event("/");
				});
				
				socket.on('config_saved', () => {
					socket.emit("get_list_configs");
				});

				socket.emit("get_list_configs");

				document.addEventListener("keydown", function (e) {
					if (e.key== " ") {
						console.log(config_edit.js_config);
					}
					keypresseds[e.key]= true;
				});
				document.addEventListener("keyup", (e) => {keypresseds[e.key]= false;});
				document.addEventListener("svg_polygons_changed", (e) => {svg_polygons_changed(e.detail)});
				document.addEventListener("js_config_changed", (e) => {js_config_changed(e.detail)});
				document.addEventListener("js_config_save", () => {
					socket.emit("save_config", config_edit.js_config);
				});
			}

		</script>
	</head>
	<body>
	</body>
</html>
