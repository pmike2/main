<!--
Partie client
-->

<!DOCTYPE html>
<html>
	<head>
		<title>TEST</title>
		<style>
			div {
				margin-left: 20px;
				margin-bottom: 10px;
				font-size : 20px;
			}
			input {
				width: 60px;
				margin-left: 10px;
				border: 0;
				background-color: rgb(200, 200, 100);
				font-size : 15px;
			}
			input.long-input {
				width: 250px;
			}
			div.folded>div {
				display: none;
			}
			#div_utilities {
				float: right;
			}
			span {
				background-color: rgb(200, 200, 200);
				padding-left: 5px;
				padding-right: 5px;
				cursor: pointer;
			}
			button {
				width: 20px;
				border: 0px;
				font-size : 20px;
				text-align: center;
				padding: 0px;
				cursor: pointer;
			}
			button.button_utilities {
				width: 60px;
			}
			button.fold-button {
				background-color: rgb(200, 100, 200);
			}
			button.randomize-button {
				background-color: rgb(100, 200, 200);
				margin-right: 10px;
			}
			button.add-button {
				background-color: rgb(150, 200, 120);
			}
			button.remove-button {
				background-color: rgb(150, 120, 120);
			}
			
			
			line {
				stroke: rgb(255,0,0);
				stroke-width: 2px;
			}
			line:hover {
				stroke-width: 6px;
			}
			circle {
				r: 3px;
			}
			circle:hover {
				r: 6px;
			}
		</style>
	</head>
	<body>
		<svg id="main_svg" width="600" height="400" onload="svg_init()">
			<rect id="svg_emprise" width="100%" height="100%" fill="rgb(200,200,200)"/>
			<g id="svg_group"></g>
		</svg>

		<div id="div_utilities">
			<button class="button_utilities" onclick="fold_all()">fold</button>
			<button class="button_utilities" onclick="unfold_all()">unfold</button>
			<button class="button_utilities" onclick="reset2default()">reset</button>
		</div>
		<div id="div_config"></div>

		<!--<script src="/socket.io/socket.io.js"></script>-->
		<script>
			var editing_mode= null;
			var coords= [];
			var svg_emprise, svg_group;
			var current_point_id= null;
			var current_line_id= null;
			var svg_width, svg_height;


			function norm(p) {
				return Math.sqrt(p.x* p.x+ p.y* p.y);
			}

			function diff(p1, p2) {
				return {"x" : p1.x- p2.x, "y" : p1.y- p2.y};
			}

			function simplify_coords(treshold) {
				function alignement(p1, p2, p3) {
					var scal= (p2.x- p1.x)* (p3.x- p1.x)+ (p2.y- p1.y)* (p3.y- p1.y);
					var n12= Math.sqrt((p2.x- p1.x)* (p2.x- p1.x)+ (p2.y- p1.y)* (p2.y- p1.y));
					var n13= Math.sqrt((p3.x- p1.x)* (p3.x- p1.x)+ (p3.y- p1.y)* (p3.y- p1.y));
					if ((n12< 1e-7) || (n13< 1e-7)) {
						console.log("pb simplify_coords")
						return 1.0;
					}
					return scal/ (n12* n13);
				}

				if (coords.length< 3) {
					return;
				}

				var result= [];
				result.push(coords[0]);
				var base= 0;
				var base2= 1;
				var tested= 2;
				var done= false;
				
				while (true) {
					while (norm(diff(coords[base], coords[base2]))< 5.0) {
						//console.log(base+ " ; "+ base2);
						base2+= 1;
						if (base2== coords.length- 1) {
							done= true;
							result.push(coords[coords.length- 1]);
							break;
						}
					}
					if (done) {
						break;
					}
					tested= base2+ 1;
					//console.log(base+ " ; "+ base2+ " ; " + tested+ " ; "+ coords.length);
					while (alignement(coords[base], coords[base2], coords[tested])> treshold) {
						tested+= 1;
						if (tested== coords.length) {
							done= true;
							result.push(coords[coords.length- 1]);
							break;
						}
					}
					if (done) {
						break;
					}
					//console.log(tested- 1);
					result.push(coords[tested- 1]);
					base= tested- 1;
					base2= tested;
					if (base2== coords.length- 1) {
						break;
					}
				}
				coords= result;
			}


			function svg_init() {
				svg_width= document.getElementById("main_svg").getAttribute("width");
				svg_height= document.getElementById("main_svg").getAttribute("height");
				svg_emprise= document.getElementById("svg_emprise");
				svg_emprise.addEventListener("mousedown", mouse_down_emprise);
				svg_emprise.addEventListener("mouseup", mouse_up_emprise);
				svg_emprise.addEventListener("mousemove", mouse_move_emprise);
				svg_emprise.addEventListener("mouseout", mouse_out_emprise);
				svg_group= document.getElementById("svg_group");
			}


			function mouse_down_emprise(e) {
				//console.log(e.offsetX+ " ; "+ e.offsetY);
				editing_mode= "CREATE";
				coords= [{"x" : e.offsetX, "y" : e.offsetY}];
			}


			function mouse_up_emprise(e) {
				//console.log(e.offsetX+ " ; "+ e.offsetY);
				if (editing_mode== "CREATE") {
					simplify_coords(0.98);
					//console.log(coords);
					update_svg();
				}
				else if (editing_mode== "MOVE_POINT") {
					current_point_id= null;
				}
				editing_mode= null;
			}


			function mouse_move_emprise(e) {
				//console.log(editing_mode);
				if (editing_mode== "CREATE") {
					coords.push({"x" : e.offsetX, "y" : e.offsetY});
				}
				else if (editing_mode== "MOVE_POINT") {
					coords[current_point_id].x= e.offsetX;
					coords[current_point_id].y= e.offsetY;
					var svg_point= document.getElementById("point_"+ current_point_id);
					svg_point.setAttribute("cx", coords[current_point_id].x);
					svg_point.setAttribute("cy", coords[current_point_id].y);
					if (current_point_id> 0) {
						var svg_line_before= document.getElementById("line_"+ (current_point_id- 1));
						svg_line_before.setAttribute("x2", coords[current_point_id].x);
						svg_line_before.setAttribute("y2", coords[current_point_id].y);
					}
					if (current_point_id< coords.length- 1) {
						var svg_line_after= document.getElementById("line_"+ current_point_id);
						svg_line_after.setAttribute("x1", coords[current_point_id].x);
						svg_line_after.setAttribute("y1", coords[current_point_id].y);
					}
				}
			}


			function mouse_out_emprise(e) {
				if ((e.offsetX< 2) || (e.offsetX> svg_width- 3) || (e.offsetY< 2) || (e.offsetY> svg_height- 3)) {
					editing_mode= null;
					current_point_id= null;
				}
			}


			function mouse_down_point(e) {
				current_point_id= parseInt(e.target.id.split("point_")[1]);

				if (e.shiftKey) {/*shift is down*/
					document.getElementById("point_"+ current_point_id).remove();
					if (current_point_id> 0) {
						document.getElementById("line_"+ (current_point_id- 1)).remove();
					}
					if (current_point_id< coords.length- 1) {
						document.getElementById("line_"+ current_point_id).remove();
					}
					if ((current_point_id> 0) && (current_point_id< coords.length- 1)) {
						var new_line= document.createElementNS("http://www.w3.org/2000/svg", "line");
						new_line.setAttribute("x1", coords[current_point_id- 1].x);
						new_line.setAttribute("y1", coords[current_point_id- 1].y);
						new_line.setAttribute("x2", coords[current_point_id+ 1].x);
						new_line.setAttribute("y2", coords[current_point_id+ 1].y);
						new_line.classList.add("lines");
						svg_group.insertBefore(new_line, document.getElementById("line_"+ (current_point_id+ 1)));
					}

					for (var i=current_point_id+ 1; i<coords.length; ++i) {
						var svg_point= document.getElementById("point_"+ i);
						svg_point.setAttribute("id", "point_"+ (i- 1));
					}
					for (var i=current_point_id+ 1; i<coords.length- 1; ++i) {
						var svg_line= document.getElementById("line_"+ i);
						svg_line.setAttribute("id", "line_"+ (i- 1));
					}

					new_line.setAttribute("id", "line_"+ (current_point_id- 1));

					coords.splice(current_point_id, 1);
					
					current_point_id= null;
				}
				else {
					editing_mode= "MOVE_POINT";
				}
				/*if (e.altKey) {}
				if (e.ctrlKey) {}
				if (e.metaKey) {}*/
			}


			function mouse_up_point(e) {
				current_point_id= null;
				editing_mode= null;
				//console.log(current_point_id);
			}


			function mouse_down_line(e) {
				var new_coord= {"x" : e.offsetX, "y" : e.offsetY};
				
				current_line_id= parseInt(e.target.id.split("line_")[1]);

				document.getElementById("line_"+ current_line_id).remove();

				var new_point= document.createElementNS("http://www.w3.org/2000/svg", "circle");
				new_point.setAttribute("cx", new_coord.x);
				new_point.setAttribute("cy", new_coord.y);
				new_point.classList.add("points");
				svg_group.insertBefore(new_point, document.getElementById("point_"+ current_line_id));

				var new_line_1= document.createElementNS("http://www.w3.org/2000/svg", "line");
				new_line_1.setAttribute("x1", coords[current_line_id].x);
				new_line_1.setAttribute("y1", coords[current_line_id].y);
				new_line_1.setAttribute("x2", new_coord.x);
				new_line_1.setAttribute("y2", new_coord.y);
				new_line_1.classList.add("lines");
				svg_group.insertBefore(new_line_1, document.getElementById("line_"+ (current_line_id- 1)));

				var new_line_2= document.createElementNS("http://www.w3.org/2000/svg", "line");
				new_line_2.setAttribute("x1", new_coord.x);
				new_line_2.setAttribute("y1", new_coord.y);
				new_line_2.setAttribute("x2", coords[current_line_id+ 1].x);
				new_line_2.setAttribute("y2", coords[current_line_id+ 1].y);
				new_line_2.classList.add("lines");
				svg_group.insertBefore(new_line_2, document.getElementById("line_"+ current_line_id));

				for (var i=coords.length- 1; i>=current_line_id+ 1; --i) {
					var svg_point= document.getElementById("point_"+ i);
					svg_point.setAttribute("id", "point_"+ (i+ 1));
				}
				for (var i=coords.length- 2; i>=current_line_id+ 1; --i) {
					var svg_line= document.getElementById("line_"+ i);
					svg_line.setAttribute("id", "line_"+ (i+ 1));
				}

				new_point.setAttribute("id", "point_"+ (current_line_id+ 1));
				new_line_1.setAttribute("id", "line_"+ current_line_id);
				new_line_2.setAttribute("id", "line_"+ (current_line_id+ 1));
				
				coords.splice(current_line_id+ 1, 0, new_coord);

				current_line_id= null;
			}


			function update_svg() {
				svg_group.innerHTML= "";
				for (var i=0; i<coords.length- 1; ++i) {
					svg_group.innerHTML+= '<line x1="'+ coords[i].x+ '" y1="'+ coords[i].y+ '" x2="'+ coords[i+ 1].x+ '" y2="'+ coords[i+ 1].y+ '" class="lines" id="line_'+ i+ '" />\n';
				}
				for (var i=0; i<coords.length; ++i) {
					svg_group.innerHTML+= '<circle cx="'+ coords[i].x+ '" cy="'+ coords[i].y+ '" class="points" id="point_'+ i+ '" />\n';
				}
				var svg_points= document.getElementsByClassName("points");
				for (var i=0; i<svg_points.length; ++i) {
					svg_points[i].addEventListener("mousedown", mouse_down_point);
					svg_points[i].addEventListener("mouseup", mouse_up_point);
				}
				var svg_lines= document.getElementsByClassName("lines");
				for (var i=0; i<svg_lines.length; ++i) {
					svg_lines[i].addEventListener("mousedown", mouse_down_line);
				}
			}


			//var socket= io();
			var js_config= {
	"mpegs" : [
		"../data/video_samples/flower_04.mov",
		"../data/video_samples/flower_06.mov"
	],
	
	"alpha_width" : 512,
	"alpha_height" : 512,
	"time_width" : 1024,
	
	"readers" : [
		{
			"alpha" : {
				"alpha_polygons" : [
					{
						"polygon" : [[0.3, 0.3], [0.5, 0.3], [0.5, 0.5], [0.3, 0.5]],
						"fadeout" : 0.1,
						"curve" : 2.0,
						"alpha_max" : 0.9
					}
				],
				"decrease_speed" : 0.05
			},
			"time" : {
				"checkpoints" : [
					[0.0, 0.0], [1.0, 1.0]
				],
				"speed" : 0.01
			}
		},
		{
			"alpha" : {
				"alpha_polygons" : [
					{
						"polygon" : [[0.6, 0.6], [0.7, 0.6], [0.7, 0.7], [0.6, 0.7]],
						"fadeout" : 0.5,
						"curve" : 1.0,
						"alpha_max" : 1.0
					}
				],
				"decrease_speed" : 0.2
			},
			"time" : {
				"checkpoints" : [
					[0.0, 0.0], [0.3, 1.0], [1.0, 0.4]
				],
				"speed" : 0.01
			}
		}
	],
	
	"keymapping_reader" : {
		"a" : {
			"mpeg" : 0, "reader" : 0
		},
		"b" : {
			"mpeg" : 1, "reader" : 0
		},
		"c" : {
			"mpeg" : 0, "reader" : 1
		}
	},

	"modifiers" : [
		{
			"movie" : {
				"mult" : [0.5, 0.7, 0.2, 0.8], "add" : [0.4, 0.3], "speed" : 0.01
			},
			"alpha" : {
				"mult" : [0.5, 0.7, 0.2, 0.8], "add" : [0.4, 0.3], "speed" : 0.01
			},
			"time" : {
				"mult" : 0.4, "add" : 0.2, "speed" : 0.01
			}
		}
	],

	"keymapping_modifier" : {
		"d" : {
			"modifier" : 0, "track" : 0
		},
		"e" : {
			"modifier" : 0, "track" : 1
		}
	}
};

			
			var js_model= {
	"__const__" : {
		"alphabet_keys" : ["a", "b", "c", "d", "e", "f", "g", "h", "i", "j", "k", "l", "m", "n", "o", "p", "r", "s", "t", "u", "v", "w", "x", "y", "z"],
		"powers_of_2" : [1, 2, 4, 8, 16, 32, 64, 128, 256, 512, 1024, 2048]
	},
	"__rules__" : [
		"for (var key in js_config['keymapping_reader']) {if (js_config['keymapping_reader'][key]['mpeg']>= js_config['mpegs'].length) {js_config['keymapping_reader'][key]['mpeg']= Math.floor(Math.random()* js_config['mpegs'].length);}}",
		"for (var key in js_config['keymapping_reader']) {if (js_config['keymapping_reader'][key]['reader']>= js_config['readers'].length) {js_config['keymapping_reader'][key]['reader']= Math.floor(Math.random()* js_config['readers'].length);}}",
		"for (var key in js_config['keymapping_modifier']) {if (js_config['keymapping_modifier'][key]['modifier']>= js_config['modifiers'].length) {js_config['keymapping_modifier'][key]['modifier']= Math.floor(Math.random()* js_config['modifiers'].length);}}"
	],
	"__root__" 				: {"type" : "dict", "keys" : ["mpegs", "alpha_width", "alpha_height", "time_width", "readers", "keymapping_reader", "modifiers", "keymapping_modifier"]},
	"mpegs"					: {"type" : "list", "values" : "path", "min_number" : 1, "max_number" : 8},
	"path"					: {"type" : "string", "default" : ""},
	"alpha_width"			: {"type" : "int", "possible_values" : "powers_of_2", "default" : 512},
	"alpha_height"			: {"type" : "int", "possible_values" : "powers_of_2", "default" : 512},
	"time_width"			: {"type" : "int", "possible_values" : "powers_of_2", "default" : 1024},
	"readers"				: {"type" : "list", "values" : "alpha_time", "min_number" : 1, "max_number" : 32},
	"alpha_time"			: {"type" : "dict", "keys" : ["readers.alpha", "readers.time"]},
	"readers.alpha"			: {"type" : "dict", "keys" : ["alpha_polygons", "decrease_speed"]},
	"alpha_polygons"		: {"type" : "list", "values" : "alpha_polygon", "min_number" : 1, "max_number" : 8},
	"alpha_polygon"			: {"type" : "dict", "keys" : ["polygon", "fadeout", "curve", "alpha_max"]},
	"polygon"				: {"type" : "list", "values" : "coords", "min_number" : 3, "max_number" : 16},
	"coords"				: {"type" : "list", "values" : "coord", "number" : 2},
	"coord"					: {"type" : "float", "min" : 0.0, "max" : 1.0, "default" : 0.0},
	"fadeout"				: {"type" : "float", "min" : 0.0, "max" : 1.0, "default" : 0.0},
	"curve"					: {"type" : "float", "min" : 0.1, "max" : 4.0, "default" : 1.0},
	"alpha_max"				: {"type" : "float", "min" : 0.0, "max" : 1.0, "default" : 1.0},
	"decrease_speed"		: {"type" : "float", "min" : 0.005, "max" : 0.1, "default" : 0.01},
	"readers.time"			: {"type" : "dict", "keys" : ["checkpoints", "readers.speed"]},
	"checkpoints"			: {"type" : "list", "values" : "coords", "min_number" : 1, "max_number" : 16},
	"readers.speed"			: {"type" : "float", "min" : 0.005, "max" : 0.1, "default" : 0.01},
	"keymapping_reader"		: {"type" : "dict", "possible_keys" : "alphabet_keys", "values" : "keymap"},
	"keymap"				: {"type" : "dict", "keys" : ["mpeg", "reader"]},
	"mpeg"					: {"type" : "int", "min" : 0, "max" : 7, "default" : 0},
	"reader"				: {"type" : "int", "min" : 0, "max" : 31, "default" : 0},
	"modifiers"				: {"type" : "list", "values" : "modif", "max_number" : 32},
	"modif"					: {"type" : "dict", "keys" : ["movie", "modifiers.alpha", "modifiers.time"]},
	"movie"					: {"type" : "dict", "keys" : ["movie.mult", "movie.add", "modifiers.speed"]},
	"movie.mult"			: {"type" : "list", "values" : "mult_elmt", "number" : 4},
	"mult_elmt"				: {"type" : "float", "min" : -3.0, "max" : 3.0, "default" : 0.0},
	"movie.add"				: {"type" : "list", "values" : "add_elmt", "number" : 2},
	"add_elmt"				: {"type" : "float", "min" : -2.0, "max" : 2.0, "default" : 0.0},
	"modifiers.speed"		: {"type" : "float", "min" : 0.005, "max" : 0.1, "default" : 0.01},
	"modifiers.alpha"		: {"type" : "dict", "keys" : ["alpha.mult", "alpha.add", "modifiers.speed"]},
	"alpha.mult"			: {"type" : "list", "values" : "mult_elmt", "number" : 4},
	"alpha.add"				: {"type" : "list", "values" : "add_elmt", "number" : 2},
	"modifiers.time"		: {"type" : "dict", "keys" : ["time.mult", "time.add", "modifiers.speed"]},
	"time.mult"				: {"type" : "float", "min" : -2.0, "max" : 2.0, "default" : 0.0},
	"time.add"				: {"type" : "float", "min" : -2.0, "max" : 2.0, "default" : 0.0},
	"keymapping_modifier"	: {"type" : "dict", "possible_keys" : "alphabet_keys", "values" : "mod_keymap"},
	"mod_keymap"			: {"type" : "dict", "keys" : ["modifier", "track"]},
	"modifier"				: {"type" : "int", "min" : 0, "max" : 31, "default" : 0},
	"track"					: {"type" : "int", "min" : 0, "max" : 7, "default" : 0}
}
			function concat_ids(parent_id, child_id) {
				if (parent_id== "/") {
					return "/"+ child_id;
				}
				return parent_id + "/"+ child_id;
			}


			function get_parent_id(id) {
				if (id== "/") {
					//return "/";
					return null;
				}
				result= id.substring(0, id.lastIndexOf("/"));
				if (result== "") {
					result= "/";
				}
				return result;
			}


			function get_all_config_ids() {
				result= [];

				function get_node_id(js_node, id) {
					result.push(id);
					if (typeof(js_node)== "object") {
						for (var key in js_node) {
							if (id!= "") {
								get_node_id(js_node[key], concat_ids(id, key));
							}
							else {
								get_node_id(js_node[key], key);
							}
						}
					}
				}

				get_node_id(js_config, "/");

				return result;
			}


			function get_config_node(node_id) {
				if (node_id[0]== "/") {
					node_id= node_id.substring(1);
				}
				if (node_id=== "") {
					return [js_config, null]
				}
				var keys= node_id.split("/");
				var js_parent_node= js_config;
				for (var i=0; i<keys.length- 1; ++i) {
					if (keys[i] in js_parent_node) {
						js_parent_node= js_parent_node[keys[i]];
					}
					else {
						return [null, null];
					}
				}
				var key= keys[keys.length- 1];
				if (key in js_parent_node) {
					return [js_parent_node, key];
				}
				return [null, null];
			}


			function get_model_node(node_id) {
				if (node_id[0]== "/") {
					node_id= node_id.substring(1);
				}
				if (node_id=== "") {
					return js_model["__root__"];
				}
				var keys= node_id.split("/");
				var model_node= js_model["__root__"];
				for (var i=0; i<keys.length; ++i) {
					if (model_node.type== "dict") {
						if ("keys" in model_node) {
							var found= false;
							for (var j=0; j<model_node.keys.length; ++j) {
								if (model_node.keys[j]== keys[i]) {
									model_node= js_model[model_node.keys[j]];
									found= true;
									break;
								}
							}
							if (!found) {
								return null;
							}
						}
						else if ("values" in model_node) {
							model_node= js_model[model_node.values];
						}
					}
					else if (model_node.type== "list") {
						model_node= js_model[model_node.values];
					}
				}
				return model_node;
			}

			
			function get_default(node_id) {
				
				function get_default_node(js, node_id) {
					var model_node= get_model_node(node_id);
					var key= node_id.split("/").pop();

					if ((model_node.type== "int") || (model_node.type== "float") || (model_node.type== "string")) {
						js[key]= model_node.default;
					}
					else if (model_node.type== "dict") {
						if ("keys" in model_node) {
							js[key]= {};
							for (var i=0; i<model_node.keys.length; ++i) {
								get_default_node(js[key], concat_ids(node_id, model_node.keys[i]));
							}
						}
						else if ("possible_keys" in model_node) {
							js[key]= {};
							get_default_node(js[key], concat_ids(node_id, model_node.possible_keys[0]));
						}
					}
					else if (model_node.type== "list") {
						var n= 1;
						if ("number" in model_node) {
							n= model_node.number;
						}
						else if ("min_number" in model_node) {
							n= model_node.min_number;
						}
						js[key]= [];
						for (var i=0; i<n; ++i) {
							get_default_node(js[key], concat_ids(node_id, i));
						}
					}
				}

				var result= {};
				var key= node_id.split("/").pop();
				get_default_node(result, node_id);
				return result[key];
			}


			function reset2default() {
				js_config= get_default("/");
				gen_dom("/", document.getElementById("div_config"));
			}

			function add_default_to_list(node_id, i) {
				var [js_parent_node, key]= get_config_node(node_id);
				var model_node= get_model_node(node_id);
				if ("number" in model_node) {
					return;
				}
				if (("max_number" in model_node) && (model_node.max_number== js_parent_node[key].length)) {
					return;
				}
				js_parent_node[key].push(get_default(concat_ids(node_id, i)));
			}


			function add_default_to_dict(node_id, k) {
				var [js_parent_node, key]= get_config_node(node_id);
				js_parent_node[key][k]= get_default(concat_ids(node_id, k));
			}


			function delete_id(node_id) {
				if (node_id== "/") {
					js_config= {};
					return;
				}
				var [js_parent_node, key]= get_config_node(node_id);
				var parent_model_node= get_model_node(get_parent_id(node_id));
				if (parent_model_node.type== "dict") {
					delete js_parent_node[key];
				}
				else if (parent_model_node.type== "list") {
					if ("number" in parent_model_node) {
						return;
					}
					if (("min_number" in parent_model_node) && (parent_model_node.min_number== js_parent_node.length)) {
						return;
					}
					js_parent_node.splice(key, 1);
				}
			}


			function randomize(node_id) {
				var [js_parent_node, key]= get_config_node(node_id);
				var model_node= get_model_node(node_id);

				if (model_node.type== "list") {
					js_parent_node[key]= [];
					var min_number= 0;
					var max_number= 10; // TODO : forcer l'existence de model_node.max_number ?
					if ("min_number" in model_node) {
						min_number= model_node.min_number;
					}
					if ("max_number" in model_node) {
						max_number= model_node.max_number;
					}
					var n= min_number+ Math.floor(Math.random()* (max_number- min_number));
					if ("number" in model_node) {
						n= model_node.number;
					}
					for (var i=0; i<n; ++i) {
						add_default_to_list(node_id, i);
						randomize(concat_ids(node_id, i));
					}
				}
				else if (model_node.type== "dict") {
					if ("keys" in model_node) {
						for (var i=0; i<model_node.keys.length; ++i) {
							randomize(concat_ids(node_id, model_node.keys[i]));
						}
					}
					else if ("possible_keys" in model_node) {
						js_parent_node[key]= {};
						var n= Math.floor(Math.random()* model_node.possible_keys.length);
						for (var i=0; i<n; ++i) {
							add_default_to_dict(node_id, model_node.possible_keys[i]);
							randomize(concat_ids(node_id, model_node.possible_keys[i]));
						}
					}
				}
				else {
					if ("possible_values" in model_node) {
						var i= Math.floor(Math.random()* model_node.possible_values.length);
						js_parent_node[key]= model_node.possible_values[i];
					}
					else {
						if (model_node.type== "int") {
							js_parent_node[key]= model_node.min+ Math.floor(Math.random()* (model_node.max+ 1- model_node.min));
						}
						else if (model_node.type== "float") {
							js_parent_node[key]= model_node.min+ Math.random()* (model_node.max- model_node.min);
						}
					}
				}
			}


			function expand_const() {
				for (key in js_model) {
					if (key!= "__const__") {
						for (k in js_model[key]) {
							for (key_const in js_model["__const__"]) {
								if (js_model[key][k]== key_const) {
									js_model[key][k]= js_model["__const__"][key_const];
								}
							}
						}
					}
				}
			}


			function complexify_keys() {
				var all_config_ids= get_all_config_ids();
				var ids2complexify= [];
				for (var i=0; i<all_config_ids.length; ++i) {
					var last_key= all_config_ids[i].split("/").pop();
					if ((!(last_key in js_model)) && (isNaN(last_key))) {
						ids2complexify.push(all_config_ids[i]);
					}
				}
				ids2complexify.sort(function(a, b) {
					return b.length- a.length;
				});
				//console.log(ids2complexify);
				var found= {};
				for (var i=0; i<ids2complexify.length; ++i) {
					var [js_parent_node, key]= get_config_node(ids2complexify[i]);
					var keys= ids2complexify[i].split("/");
					var last_key= keys[keys.length- 1];
					found[ids2complexify[i]]= false;
					for (var k in js_model) {
						if ((k.includes(".")) && (k.split(".")[1]== last_key)) {
							for (var j=keys.length- 1; j>=0; --j){
								if (keys[j]== k.split(".")[0]) {
									js_parent_node[k]= JSON.parse(JSON.stringify(js_parent_node[key]));
									delete js_parent_node[key];
									found[ids2complexify[i]]= true;
									break;
								}
							}
						}
						if (found[ids2complexify[i]]) {
							break;
						}
					}
				}
			}

			
			function get_simplified_key(key) {
				if (key.includes(".")) {
					return key.split(".").pop();
				}
				return key;
			}


			function simplify_keys() {
				var all_config_ids= get_all_config_ids();
				all_config_ids.sort(function(a, b) {
					return b.length- a.length;
				});

				for (var i=0; i<all_config_ids.length; ++i) {
					var [js_parent_node, key]= get_config_node(all_config_ids[i]);
					if ((key!== null) && (key.includes("."))) {
						js_parent_node[get_simplified_key(key)]= js_parent_node[key];
						delete js_parent_node[key];
					}
				}
			}


			function enforce_rules() {
				for (var i=0; i<js_model["__rules__"].length; ++i) {
					var f = new Function("js_config", js_model["__rules__"][i]);
					f(js_config);
				}
			}


			function get_div_node(node_id) {
				return document.querySelector('div[node_id="'+ node_id+ '"]');
			}


			function get_fold_button_node(node_id) {
				return document.querySelector('button[node_id="'+ node_id+ '"].fold-button');
			}


			function is_fold(node_id) {
				var div_node= get_div_node(node_id);
				return div_node.classList.contains("folded");
			}
			

			function toggle_fold(node_id) {
				var div_node= get_div_node(node_id);
				var button_node= get_fold_button_node(node_id);
				if (is_fold(node_id)) {
					unfold(node_id);
				}
				else {
					fold(node_id);
				}
			}
			

			function fold(node_id) {
				var div_node= get_div_node(node_id);
				var button_node= get_fold_button_node(node_id);
				if ((div_node=== null) || (button_node=== null)) {
					return;
				}
				if (!is_fold(node_id)) {
					div_node.classList.add("folded");
				}
				button_node.innerHTML= ">";
			}


			function unfold(node_id) {
				var div_node= get_div_node(node_id);
				var button_node= get_fold_button_node(node_id);
				if ((div_node=== null) || (button_node=== null)) {
					return;
				}
				if (is_fold(node_id)) {
					div_node.classList.remove("folded");
				}
				button_node.innerHTML= "v";
			}


			function fold_all() {
				node_ids= get_all_config_ids();
				for (var i=0; i<node_ids.length; ++i) {
					fold(node_ids[i]);
				}
			}


			function unfold_all() {
				node_ids= get_all_config_ids();
				for (var i=0; i<node_ids.length; ++i) {
					unfold(node_ids[i]);
				}
			}


			function gen_dom(node_id, parent_html_node) {
				var [js_parent_node, key]= get_config_node(node_id);
				var model_node= get_model_node(node_id);
				
				//console.log("------");
				//console.log(node_id);
				//console.log(js_parent_node);
				//console.log(key);
				//console.log(model_node);
				
				var div_elmt= get_div_node(node_id);
				var was_fold= null;
				if (div_elmt!== null) {
					div_elmt.innerHTML= "";
					was_fold= is_fold(node_id);
				}
				else {
					div_elmt= document.createElement("div");
					div_elmt.setAttribute("node_id", node_id);
					parent_html_node.appendChild(div_elmt);
				}
				
				if (key!== null) {
					div_elmt.innerHTML= "<span>"+ get_simplified_key(key)+ "</span>";
				}

				var button_randomize_elmt= document.createElement("button");
				button_randomize_elmt.setAttribute("node_id", node_id);
				button_randomize_elmt.innerHTML= "R";
				button_randomize_elmt.classList.add("randomize-button");
				button_randomize_elmt.addEventListener("click", function() {
					randomize(this.getAttribute("node_id"));
					enforce_rules(js_config);
					gen_dom(node_id, parent_html_node);
				});
				div_elmt.insertBefore(button_randomize_elmt, div_elmt.firstChild);

				if (model_node.type== "list") {
					var button_add_elmt= document.createElement("button");
					button_add_elmt.setAttribute("node_id", node_id);
					button_add_elmt.innerHTML= "+";
					button_add_elmt.classList.add("add-button");
					button_add_elmt.addEventListener("click", function() {
						add_default_to_list(node_id, js_parent_node[key].length);
						enforce_rules(js_config);
						gen_dom(node_id, parent_html_node);
					});
					div_elmt.insertBefore(button_add_elmt, div_elmt.firstChild);
				}
				else if ((model_node.type== "dict") && ("possible_keys" in model_node)) {
					var button_add_elmt= document.createElement("button");
					button_add_elmt.setAttribute("node_id", node_id);
					button_add_elmt.innerHTML= "+";
					button_add_elmt.classList.add("add-button");
					button_add_elmt.addEventListener("click", function() {
						var idx_key= 0;
						if (Object.keys(js_parent_node[key]).length> 0) {
							idx_key= Math.max(...Object.keys(js_parent_node[key]).map(x => model_node.possible_keys.indexOf(x)))+ 1;
						}
						add_default_to_dict(node_id, model_node.possible_keys[idx_key]);
						enforce_rules(js_config);
						gen_dom(node_id, parent_html_node);
					});
					div_elmt.insertBefore(button_add_elmt, div_elmt.firstChild);
				}

				var parent_node_id= get_parent_id(node_id);
				if (parent_node_id!== null) {
					var parent_model_node= get_model_node(parent_node_id);
					if ((parent_model_node.type== "list") || ((parent_model_node.type== "dict") && ("possible_keys" in parent_model_node))) {
						var button_remove_elmt= document.createElement("button");
						button_remove_elmt.setAttribute("node_id", node_id);
						button_remove_elmt.innerHTML= "-";
						button_remove_elmt.classList.add("remove-button");
						button_remove_elmt.addEventListener("click", function() {
							delete_id(node_id);
							gen_dom(parent_node_id, parent_html_node.parentNode);
						});
						div_elmt.insertBefore(button_remove_elmt, div_elmt.firstChild);
					}
				}

				if ((model_node.type== "int") || (model_node.type== "float") || (model_node.type== "string")) {
					var input_elmt= document.createElement("input");
					input_elmt.value= js_parent_node[key];
					div_elmt.appendChild(input_elmt);

					if (model_node.type== "string") {
						input_elmt.classList.add("long-input");
					}
					
					if ("possible_values" in model_node) {
						input_elmt.addEventListener('click', mouse_event => {
							mouse_event.target.value = '' 
						});
						input_elmt.setAttribute("list", "possible_values_"+ key);
						var datalist_elmt= document.createElement("datalist");
						datalist_elmt.setAttribute("id", "possible_values_"+ key);
						for (var i=0; i<model_node.possible_values.length; ++i) {
							var option_elmt= document.createElement("option");
							option_elmt.setAttribute("value", model_node.possible_values[i]);
							datalist_elmt.appendChild(option_elmt);
						}
						div_elmt.appendChild(datalist_elmt);
					}
					else {
						if ((model_node.type== "int") || (model_node.type== "float")) {
							input_elmt.setAttribute("type", "number");
							if ("min" in model_node) {
								input_elmt.setAttribute("min", model_node.min);
								input_elmt.addEventListener("change", function() {
									if (parseFloat(this.value)< parseFloat(model_node.min)) {
										this.value= model_node.min;
									}
								});
							}
							if ("max" in model_node) {
								input_elmt.setAttribute("max", model_node.max);
								input_elmt.addEventListener("change", function() {
									if (parseFloat(this.value)> parseFloat(model_node.max)) {
										this.value= model_node.max;
									}
								});
							}
							if (model_node.type== "float") {
								input_elmt.setAttribute("step", 0.01);
							}
						}
					}
				}
				else if ((model_node.type== "dict") || (model_node.type== "list")) {
					var button_fold_elmt= document.createElement("button");
					button_fold_elmt.setAttribute("node_id", node_id);
					button_fold_elmt.classList.add("fold-button");
					button_fold_elmt.addEventListener("click", function() {
						toggle_fold(this.getAttribute("node_id"));
					});
					
					div_elmt.insertBefore(button_fold_elmt, div_elmt.firstChild);
					if (was_fold=== true) {
						fold(node_id);
					}
					else if (was_fold=== false) {
						unfold(node_id);
					}
					else if (was_fold=== null) {
						fold(node_id);
					}

					if (node_id== "/") {
						for (var k in js_parent_node) {
							gen_dom(concat_ids(node_id, k), div_elmt);
						}
					}
					else {
						for (var k in js_parent_node[key]) {
							gen_dom(concat_ids(node_id, k), div_elmt);
						}
					}
				}
			}


			//expand_const();
			//complexify_keys();
			//gen_dom("/", document.getElementById("div_config"));

			//node_id= "/";
			//console.log(get_parent_id(node_id));
			//console.log(get_all_config_ids());
			//console.log(get_config_node(node_id));
			//console.log(get_model_node(node_id));
			//console.log(get_default(node_id));
			//add_default_to_list(node_id, 0);
			//add_default_to_dict(node_id, "d");
			//delete_id(node_id);
			//randomize(node_id);
			//enforce_rules(js_config);
			//simplify_keys();
			//console.log(js_config);
			//fold_all();

			/*
			socket.on('send2client', (msg) => {
				//console.log(JSON.stringify(msg));
				js_config= msg;
				sync_html();
			});*/
		</script>
	</body>
</html>
